{% extends "app_general/base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>ตะกร้าสินค้าของคุณ</h2>
    {% if cart_items %}
    <form id="cart-update-form" method="POST" action="{#}">
        {% csrf_token %}
        <table class="table">
            <thead>
                <tr>
                    <th>สินค้า</th>
                    <th>ราคาต่อหน่วย</th>
                    <th>จำนวน</th>
                    <th>ราคารวม</th>
                    <th>ลบ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>
                        <img src="{{ item.product.product_cover.url }}" width="50" height="50">
                        {{ item.product.name }}
                    </td>
                    <td>{{ item.product.price }}</td>
                    <td>
                        <input type="number" name="quantity_{{ item.id }}" value="{{ item.quantity }}" min="1" class="quantity-input">
                    </td>
                    <td class="item-total-price" data-price="{{ item.total_price }}">{{ item.total_price }}</td>
                    <td>
                        <input type="checkbox" name="remove_items" value="{{ item.id }}" class="remove-item-checkbox">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="d-flex justify-content-between align-items-center">
            <button type="submit" class="btn btn-primary">อัปเดตตะกร้าสินค้า</button>
            <div>ราคารวมสุทธิ: <span id="total-price">0</span> บาท</div>
        </div>
    </form>
    {% else %}
        <p>ตะกร้าสินค้าของคุณว่างเปล่า</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const removeItemCheckboxes = document.querySelectorAll('.remove-item-checkbox');
    const totalPriceElement = document.getElementById('total-price');
    
    // ฟังก์ชันคำนวณราคารวม
    function calculateTotal() {
        let total = 0;
        quantityInputs.forEach(input => {
            if (input.closest('tr').querySelector('.remove-item-checkbox').checked === false) {
                const pricePerItem = input.closest('tr').querySelector('.item-total-price').getAttribute('data-price');
                total += parseFloat(pricePerItem);
            }
        });
        totalPriceElement.textContent = total.toFixed(2);
    }

    // อัปเดตราคารวมเมื่อมีการเปลี่ยนแปลง
    quantityInputs.forEach(input => input.addEventListener('change', calculateTotal));
    removeItemCheckboxes.forEach(checkbox => checkbox.addEventListener('change', calculateTotal));
    
    calculateTotal();
});
</script>
{% endblock %}

